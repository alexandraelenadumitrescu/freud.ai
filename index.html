<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transylvania Blood Network</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      /* CSS pentru site-ul principal */
      body {
        margin: 0;
        padding: 0;
        font-family: "Cinzel Decorative", serif;
        background-color: #0d0d0d;
        color: #f5f5f5;
        overflow-x: hidden;
        position: relative;
        background-image: url("https://images.unsplash.com/photo-1542848906-8809e6c38b25?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: -1;
      }

      #initial-welcome-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 100000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #f5f5f5;
        text-align: center;
        opacity: 1;
        transition: opacity 1s ease-in-out, visibility 1s ease-in-out;
        visibility: visible;
      }

      #initial-welcome-overlay.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      #initial-welcome-overlay .welcome-image {
        max-width: 80%;
        max-height: 50vh;
        border: 3px solid #e60000;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.7);
        border-radius: 8px;
        margin-bottom: 30px;
        object-fit: contain;
      }

      #initial-welcome-overlay h2 {
        color: #e60000;
        font-size: 2.5em;
        margin-bottom: 15px;
        text-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
      }

      #initial-welcome-overlay p {
        font-size: 1.2em;
        color: #ccc;
        margin-bottom: 40px;
        font-family: "Dancing Script", cursive;
      }

      #initial-welcome-overlay button {
        background-color: #e60000;
        color: #f5f5f5;
        padding: 15px 30px;
        border: 2px solid #ff3333;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.3em;
        font-weight: bold;
        letter-spacing: 1px;
        transition: background-color 0.3s ease, transform 0.2s ease,
          box-shadow 0.3s ease;
      }

      #initial-welcome-overlay button:hover {
        background-color: #cc0000;
        transform: scale(1.05);
        box-shadow: 0 0 25px rgba(255, 0, 0, 0.9);
      }

      header {
        background-color: #1a1a1a;
        padding: 20px;
        text-align: center;
        font-size: 32px;
        color: #e60000;
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .header-logo {
        height: 80px;
        width: auto;
        margin-right: 15px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      }

      nav {
        background-color: #1a1a1a;
        padding: 10px 0;
        text-align: center;
        position: sticky;
        top: 72px;
        z-index: 999;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .nav-row {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 5px;
      }

      .nav-row:last-child {
        margin-bottom: 0;
      }

      nav a {
        color: #ccc;
        margin: 0 15px;
        text-decoration: none;
        font-size: 1.1em;
        transition: color 0.3s ease, text-shadow 0.3s ease;
        display: flex;
        align-items: center;
        white-space: nowrap;
        padding: 5px 0;
      }

      nav a i {
        margin-right: 8px;
        font-size: 1.2em;
        color: #e60000;
        transition: color 0.3s ease;
      }

      nav a:hover {
        color: #e60000;
        text-shadow: 0 0 8px rgba(255, 0, 0, 0.7);
      }

      nav a:hover i {
        color: #ff3333;
      }

      section {
        padding: 40px;
        max-width: 700px;
        margin: auto;
        line-height: 1.6;
        background-color: rgba(26, 26, 26, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(230, 0, 0, 0.4);
        margin-top: 30px;
        position: relative;
        z-index: 10;
      }

      h2 {
        color: #e60000;
        text-align: center;
        margin-bottom: 25px;
        font-size: 2em;
      }

      input,
      select,
      button,
      textarea {
        padding: 12px;
        margin-top: 10px;
        width: calc(100% - 24px);
        background: #2a2a2a;
        color: #f5f5f5;
        border: 1px solid #e60000;
        border-radius: 5px;
        font-family: "Cinzel Decorative", serif;
        font-size: 1em;
        transition: background 0.3s ease, border-color 0.3s ease,
          box-shadow 0.3s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #ff3333;
        box-shadow: 0 0 8px rgba(255, 51, 51, 0.6);
      }

      button {
        background-color: #e60000;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        font-weight: bold;
        letter-spacing: 1px;
      }

      button:hover {
        background-color: #cc0000;
      }

      #letter {
        background-color: rgba(26, 26, 26, 0.8);
        padding: 20px;
        border: 1px dashed #e60000;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: inset 0 0 10px rgba(230, 0, 0, 0.3);
        white-space: pre-wrap;
      }

      #output {
        font-family: "Dancing Script", cursive;
        font-size: 1.5em;
        color: #ccc;
        min-height: 200px;
      }

      .typing-cursor::after {
        content: "|";
        display: inline-block;
        animation: blink-caret 0.75s infinite;
      }

      @keyframes blink-caret {
        from,
        to {
          border-color: transparent;
        }
        50% {
          border-color: #e60000;
        }
      }

      .bat {
        position: fixed;
        width: 60px;
        height: auto;
        pointer-events: none;
        opacity: 0.7;
        filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.3));
        z-index: 5;
      }

      @keyframes flyToRight {
        0% {
          transform: translateX(0vw) translateY(var(--startY)) scaleX(1);
          opacity: 0.7;
        }
        50% {
          transform: translateX(50vw) translateY(var(--midY)) scaleX(1);
        }
        100% {
          transform: translateX(100vw) translateY(var(--endY)) scaleX(1);
          opacity: 0.7;
        }
      }

      @keyframes flyToLeft {
        0% {
          transform: translateX(100vw) translateY(var(--startY)) scaleX(-1);
          opacity: 0.7;
        }
        50% {
          transform: translateX(50vw) translateY(var(--midY)) scaleX(-1);
        }
        100% {
          transform: translateX(0vw) translateY(var(--endY)) scaleX(-1);
          opacity: 0.7;
        }
      }

      .blood-drop {
        position: absolute;
        background-color: #e60000;
        border-radius: 50%;
        opacity: 0.8;
        pointer-events: none;
        animation: drip 1s ease-out forwards;
        filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.7));
      }

      @keyframes drip {
        0% {
          transform: translateY(0) scale(0.5);
          opacity: 0.8;
        }
        100% {
          transform: translateY(50px) scale(1);
          opacity: 0;
        }
      }

      .mist-overlay {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0;
        background: linear-gradient(to top, rgba(230, 0, 0, 0.2), transparent);
        z-index: 20;
        pointer-events: none;
        transition: height 0.5s ease-out;
      }

      #mouse-glow {
        position: fixed;
        width: 50px;
        height: 50px;
        background-color: rgba(255, 0, 0, 0.1);
        border-radius: 50%;
        pointer-events: none;
        transform: translate(-50%, -50%);
        filter: blur(20px);
        z-index: 50;
        opacity: 0;
        transition: opacity 0.5s ease-out;
      }

      #sound-toggle-button {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: #f5f5f5;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        z-index: 200;
        transition: background-color 0.3s ease, transform 0.2s ease,
          box-shadow 0.3s ease;
      }

      #sound-toggle-button:hover {
        background-color: #e0e0e0;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
      }

      #sound-toggle-button img {
        width: 35px;
        height: 35px;
        display: block;
        object-fit: contain;
      }

      #sound-on-icon {
        display: none;
      }

      #bat-catcher-game {
        background-color: rgba(26, 26, 26, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(230, 0, 0, 0.4);
        margin-top: 30px;
        padding: 20px;
        text-align: center;
      }

      #game-area {
        width: 100%;
        height: 300px;
        border: 2px dashed #e60000;
        margin: 20px auto;
        position: relative;
        overflow: hidden;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        cursor: crosshair;
      }

      .game-bat {
        position: absolute;
        width: 80px;
        height: auto;
        cursor: pointer;
        transition: transform 0.1s ease-out;
        filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5));
      }

      .game-bat:hover {
        transform: scale(1.1);
      }

      #game-info {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #f5f5f5;
      }

      #game-start-button {
        background-color: #008000;
        transition: background-color 0.3s ease;
      }

      #game-start-button:hover {
        background-color: #006400;
      }

      #game-start-button.disabled {
        background-color: #555;
        cursor: not-allowed;
      }

      #transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("dracula.jpeg");
        background-size: cover;
        background-position: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 1.5s ease-in-out;
      }

      #contact-us form label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        color: #e60000;
        font-weight: bold;
      }

      #contact-us textarea {
        min-height: 120px;
        resize: vertical;
      }

      #contact-us .success-message {
        margin-top: 20px;
        padding: 15px;
        background-color: rgba(0, 128, 0, 0.3);
        border: 1px solid #008000;
        border-radius: 5px;
        color: #f5f5f5;
        text-align: center;
        font-weight: bold;
        display: none;
      }

      #vampire-quiz {
        background-color: rgba(26, 26, 26, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(230, 0, 0, 0.4);
        margin-top: 30px;
        padding: 20px;
      }

      .quiz-question {
        background-color: rgba(42, 42, 42, 0.7);
        border: 1px solid #550000;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: left;
      }

      .quiz-question p {
        font-size: 1.1em;
        color: #f5f5f5;
        margin-bottom: 15px;
      }

      .quiz-options {
        display: grid;
        gap: 10px;
      }

      .quiz-options label {
        display: block;
        background: #2a2a2a;
        color: #ccc;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e60000;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .quiz-options label:hover {
        background-color: #3a0000;
        color: #fff;
      }

      .quiz-options input[type="radio"] {
        margin-right: 10px;
        accent-color: #e60000;
      }

      #submit-quiz {
        background-color: #e60000;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        font-weight: bold;
        letter-spacing: 1px;
        padding: 12px;
        border: none;
        border-radius: 5px;
        color: #f5f5f5;
        font-family: "Cinzel Decorative", serif;
        font-size: 1em;
        transition: background-color 0.3s ease;
      }

      #submit-quiz:hover {
        background-color: #cc0000;
      }

      #quiz-result {
        margin-top: 20px;
        text-align: center;
        font-size: 1.3em;
        color: #e60000;
        font-family: "Dancing Script", cursive;
      }

      #result-description {
        margin-top: 10px;
        text-align: center;
        color: #ccc;
        font-style: italic;
      }

      .quiz-progress {
        color: #ccc;
        text-align: center;
        margin-bottom: 15px;
        font-style: italic;
      }

      .quiz-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      .quiz-navigation button {
        background-color: #550000;
        color: #f5f5f5;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-family: "Cinzel Decorative", serif;
      }

      .quiz-navigation button:hover {
        background-color: #770000;
      }

      #countdown-timer {
        background: linear-gradient(
          135deg,
          rgba(26, 26, 26, 0.95),
          rgba(42, 42, 42, 0.85)
        );
        border: 2px solid #e60000;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 0 30px rgba(230, 0, 0, 0.6),
          inset 0 0 20px rgba(0, 0, 0, 0.8);
        position: relative;
        overflow: hidden;
      }

      #countdown-timer::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #e60000, #ff3333, #cc0000, #e60000);
        border-radius: 15px;
        z-index: -1;
        animation: borderPulse 3s ease-in-out infinite;
      }

      @keyframes borderPulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }

      .countdown-title {
        font-size: 1.8em;
        color: #e60000;
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(230, 0, 0, 0.8);
        letter-spacing: 2px;
      }

      .timer-display {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .time-unit {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #e60000;
        border-radius: 10px;
        padding: 15px 10px;
        min-width: 80px;
        position: relative;
        overflow: hidden;
      }

      .time-unit::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(230, 0, 0, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .time-number {
        font-size: 2.5em;
        color: #f5f5f5;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
        display: block;
        line-height: 1;
        animation: numberGlow 2s ease-in-out infinite alternate;
      }

      @keyframes numberGlow {
        from {
          text-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
        }
        to {
          text-shadow: 0 0 25px rgba(255, 0, 0, 1),
            0 0 35px rgba(255, 0, 0, 0.5);
        }
      }

      .time-label {
        font-size: 0.9em;
        color: #ccc;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
      }

      .countdown-message {
        margin-bottom: 20px;
        font-size: 1.2em;
        color: #ccc;
        font-style: italic;
        min-height: 25px;
      }

      .countdown-finished {
        animation: finishedPulse 1s ease-in-out infinite;
        color: #ff3333 !important;
        font-weight: bold;
      }

      @keyframes finishedPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .demo-button {
        background: linear-gradient(135deg, #e60000, #cc0000);
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        color: #f5f5f5;
        font-family: "Cinzel Decorative", serif;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 20px;
        width: 100%;
      }

      .demo-button:hover {
        background: linear-gradient(135deg, #ff3333, #e60000);
        box-shadow: 0 0 15px rgba(230, 0, 0, 0.8);
        transform: translateY(-2px);
      }

      #donation-confirmation-box {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: rgba(26, 26, 26, 0.9);
        border: 2px solid #e60000;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 500;
        box-shadow: 0 0 15px rgba(230, 0, 0, 0.7);
        opacity: 0;
        visibility: hidden;
        transform: translateY(100%);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out,
          visibility 0.5s ease-out;
      }

      #donation-confirmation-box.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      #donation-confirmation-box img {
        width: 50px;
        height: auto;
      }

      #donation-confirmation-box p {
        margin: 0;
        color: #f5f5f5;
        font-size: 1.1em;
        font-family: "Dancing Script", cursive;
        text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
      }

      /* CSS pentru harta */
      #transylvania-map {
        display: none;
        padding: 40px;
        max-width: 800px;
        margin: auto;
        line-height: 1.6;
        background-color: rgba(26, 26, 26, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(230, 0, 0, 0.4);
        margin-top: 30px;
        position: relative;
        z-index: 10;
      }

      #map {
        height: 500px;
        width: 100%;
        border-radius: 10px;
        margin-top: 20px;
      }

      /* CSS pentru jocul 3D */
      .lab-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background-color: #1a1a1a;
      }

      .lab-header {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 850px;
        background-color: rgba(43, 0, 0, 0.85);
        border: 2px solid #5a0000;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
        text-align: center;
        z-index: 10;
        backdrop-filter: blur(5px);
      }

      .lab-canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        cursor: grab;
      }

      .close-lab {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #8b0000;
        color: #f5f5dc;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 16px;
        cursor: pointer;
        z-index: 100;
      }

      #info-panel {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 850px;
        background-color: rgba(43, 0, 0, 0.85);
        border: 2px solid #5a0000;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
        text-align: center;
        z-index: 10;
        backdrop-filter: blur(5px);
      }

      #instructions {
        color: #e0e0e0;
        font-size: 1.3em;
        min-height: 40px;
      }

      #canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        cursor: grab;
      }

      canvas {
        display: block;
      }

      #lab-container button {
        background-color: #8b0000;
        color: #f5f5dc;
        padding: 12px 25px;
        border: 2px solid #a00000;
        border-radius: 8px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 5px;
        font-family: "MedievalSharp", cursive, sans-serif;
        box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
      }

      #lab-container button:hover:not(:disabled) {
        background-color: #a00000;
        transform: translateY(-2px);
        box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.6);
      }

      #lab-container button:disabled {
        background-color: #555;
        color: #999;
        cursor: not-allowed;
      }

      #lab-container select {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #5a0000;
        margin: 0 10px;
        font-size: 1em;
        background-color: #3a1a1a;
        color: #f5f5dc;
        font-family: "MedievalSharp", cursive, sans-serif;
      }

      .hidden {
        display: none !important;
      }

      #final-feedback-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
        z-index: 100;
        text-align: center;
      }
      #final-feedback-text {
        font-size: 3.5em;
        font-weight: bold;
        text-shadow: 3px 3px 8px black;
        padding: 20px;
      }
      #final-feedback-overlay.success {
        background: rgba(49, 115, 52, 0.85);
      }
      #final-feedback-overlay.error {
        background: rgba(169, 50, 38, 0.85);
      }

      @media (max-width: 768px) {
        #initial-welcome-overlay .welcome-image {
          max-width: 90%;
          max-height: 40vh;
          margin-bottom: 20px;
        }
        #initial-welcome-overlay h2 {
          font-size: 1.8em;
        }
        #initial-welcome-overlay p {
          font-size: 1em;
          padding: 0 15px;
        }
        #initial-welcome-overlay button {
          font-size: 1em;
          padding: 12px 25px;
        }

        header {
          font-size: 24px;
          flex-direction: column;
        }

        .header-logo {
          height: 60px;
          margin-bottom: 10px;
          margin-right: 0;
        }

        nav {
          top: 60px;
          padding: 8px 0;
        }

        nav a {
          margin: 0 8px;
          font-size: 0.9em;
          padding: 3px 0;
        }

        nav a i {
          margin-right: 5px;
          font-size: 1em;
        }

        section {
          padding: 20px;
          margin: 20px auto;
        }

        #sound-toggle-button {
          width: 50px;
          height: 50px;
          bottom: 10px;
          left: 10px;
        }

        #sound-toggle-button img {
          width: 28px;
          height: 28px;
        }

        #game-area {
          height: 200px;
        }

        #vampire-quiz {
          padding: 20px;
        }

        .timer-display {
          gap: 10px;
        }

        .time-unit {
          min-width: 70px;
          padding: 10px 5px;
        }

        .time-number {
          font-size: 2em;
        }

        .countdown-title {
          font-size: 1.5em;
        }

        #donation-confirmation-box {
          bottom: 10px;
          right: 10px;
          padding: 10px;
          flex-direction: column;
          text-align: center;
        }

        #donation-confirmation-box img {
          width: 40px;
        }

        #donation-confirmation-box p {
          font-size: 0.9em;
        }
      }
    </style>
  </head>
  <body>
    <div id="initial-welcome-overlay">
      <img src="dracula.jpeg" alt="Dracula Welcome" class="welcome-image" />
      <h2>Welcome to the Transylvania Blood Network.</h2>
      <p>Prepare to delve into the shadows...</p>
      <button id="enter-site-button">Enter at Your Own Risk</button>
    </div>

    <div id="bat-container"></div>
    <div id="mouse-glow"></div>
    <div class="mist-overlay" id="mist-overlay"></div>

    <div id="transition-overlay"></div>

    <audio id="bat-sound" loop>
      <source src="Toccata-and-fugue-in-d-minor.mp3" type="audio/mp3" />
      Your browser does not support the audio element.
    </audio>
    <audio id="drip-sound">
      <source src="water-drip-72357.mp3" type="audio/mp3" />
    </audio>
    <audio id="chime-sound">
      <source src="spooky-chimes-359877.mp3" type="audio/mp3" />
    </audio>
    <audio id="typing-sound">
      <source src="typewriter-100-88009.mp3" type="audio/mp3" />
      Your browser does not support the audio element.
    </audio>
    <audio id="wolf-howl-sound">
      <source src="wolf-howl.mp3" type="audio/mp3" />
      Your browser does not support the audio element.
    </audio>
    <audio id="evil-laugh-sound">
      <source src="evil-laugh-89423.mp3" type="audio/mp3" />
      Your browser does not support the audio element.
    </audio>

    <header>
      <img
        src="blood-donors-needed-halloween-dracula-volunteer-light-nikita-goel.jpg"
        alt="Transylvania Blood Network Logo"
        class="header-logo"
      />
      🩸 Transylvania Blood Network
    </header>

    <nav>
      <div class="nav-row">
        <a href="#home"><i class="fas fa-home"></i> Home</a>
        <a href="#donate"><i class="fas fa-hand-holding-heart"></i> Donate</a>
        <a href="#registered-donors"><i class="fas fa-users"></i> Donors</a>
        <a href="#facts-cravings"><i class="fas fa-scroll"></i> Secrets</a>
        <a href="#bat-catcher-game"
          ><i class="fas fa-crosshairs"></i> Catch Vlad!</a
        >
      </div>
      <div class="nav-row">
        
        
        <a href="game.html">Blood Lab</a>
        <a href="#vampire-quiz"
          ><i class="fas fa-question-circle"></i> Vampire Quiz</a
        >
        <a href="#countdown-section"
          ><i class="fas fa-moon"></i> Transformation</a
        >
        <a href="#letter"
          ><i class="fas fa-envelope-open-text"></i> Your Letter</a
        >
      </div>
      <div class="nav-row">
        <a href="#contact-us"><i class="fas fa-paper-plane"></i> Contact</a>
        <a href="#about"><i class="fas fa-info-circle"></i> About</a>
      </div>
    </nav>

    <section id="home">
      <h2>Welcome</h2>
      <p>
        Transylvania Blood Network connects generous donors with those who need
        them most. But more than blood, we deliver humanity, wrapped in a veil
        of ancient mystery. Every pulse, a story. Every drop, a destiny.
      </p>
    </section>

    <section id="donate">
      <h2>Become a Donor</h2>
      <label for="name">Your Name</label>
      <input type="text" id="name" placeholder="Enter your name..." />

      <label for="group">Blood Group</label>
      <select id="group">
        <option>A+</option>
        <option>A-</option>
        <option>B+</option>
        <option>B-</option>
        <option>AB+</option>
        <option>AB-</option>
        <option>O+</option>
        <option>O-</option>
      </select>

      <button onclick="submitDonor()">Generate Letter</button>
    </section>

    <section id="registered-donors">
      <h2>Registered Donors & Blood Inventory</h2>
      <div
        id="donor-list-container"
        style="
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #e60000;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 20px;
        "
      >
        <p id="no-donors-message" style="text-align: center; color: #ccc">
          No donors registered yet.
        </p>
        <ul id="donor-list" style="list-style-type: none; padding: 0"></ul>
      </div>
      <div
        id="blood-inventory"
        style="
          background-color: rgba(42, 42, 42, 0.8);
          padding: 15px;
          border-radius: 5px;
          border: 1px solid #e60000;
        "
      >
        <h3>Current Blood Inventory:</h3>
        <p id="inventory-summary" style="color: #f5f5f5">
          No blood data available.
        </p>
      </div>
      <button
        onclick="clearAllDonors()"
        style="margin-top: 20px; background-color: #550000"
      >
        Clear All Donors (Local)
      </button>
    </section>

    <section id="facts-cravings">
      <h2>Transylvanian Secrets & Cravings</h2>

      <h3>Random Vampire Fact:</h3>
      <button onclick="displayRandomVampireFact()">Reveal a Secret</button>
      <p
        id="vampire-fact-output"
        style="margin-top: 15px; font-style: italic; color: #ccc"
      >
        Click to uncover ancient truths.
      </p>

      <h3 style="margin-top: 30px">Blood Type Craving Compatibility:</h3>
      <label for="craving-group">Select Blood Type:</label>
      <select id="craving-group">
        <option>A+</option>
        <option>A-</option>
        <option>B+</option>
        <option>B-</option>
        <option>AB+</option>
        <option>AB-</option>
        <option>O+</option>
        <option>O-</option>
      </select>
      <button onclick="getBloodCraving()">Discover Cravings</button>
      <p
        id="craving-output"
        style="margin-top: 15px; font-style: italic; color: #ccc"
      >
        What will your blood crave tonight?
      </p>
    </section>

    <section id="bat-catcher-game">
      <h2>Catch Vlad!</h2>
      <p>
        Click on Vlad Tepes as fast as you can to score points before time runs
        out!
      </p>
      <div id="game-info">
        <span id="score-display">Score: 0</span>
        <span id="timer-display">Time: 30s</span>
      </div>
      <div id="game-area"></div>
      <button id="game-start-button">Start Game!</button>
    </section>


    <section id="vampire-quiz">
      <h2>How Much Vampire Are You?</h2>
      <p class="quiz-progress" id="quiz-progress">Question 1 of 10</p>
      <div id="quiz-container"></div>
      <div class="quiz-navigation" id="quiz-navigation">
        <button id="prev-question" style="display: none">← Previous</button>
        <button id="next-question">Next →</button>
      </div>
      <button id="submit-quiz" style="display: none">
        Reveal Your True Nature
      </button>
      <div id="quiz-result"></div>
      <div id="result-description"></div>
    </section>

    <section id="countdown-section">
      <h2>Transformation Countdown</h2>
      <div id="countdown-timer">
        <div class="countdown-title">⏰ Time Until Next Blood Moon</div>

        <div class="timer-display">
          <div class="time-unit">
            <span class="time-number" id="days">00</span>
            <div class="time-label">Days</div>
          </div>
          <div class="time-unit">
            <span class="time-number" id="hours">00</span>
            <div class="time-label">Hours</div>
          </div>
          <div class="time-unit">
            <span class="time-number" id="minutes">00</span>
            <div class="time-label">Minutes</div>
          </div>
          <div class="time-unit">
            <span class="time-number" id="seconds">00</span>
            <div class="time-label">Seconds</div>
          </div>
        </div>

        <div class="countdown-message" id="countdown-message">
          Register as a donor to begin your mystical transformation countdown...
        </div>

        <button class="demo-button" onclick="startDemoCountdown()">
          🩸 Become a Donor (Demo)
        </button>
      </div>
    </section>

    <section id="letter">
      <h2>Your Letter</h2>
      <div id="output">Fill in your data above to see your letter.</div>
    </section>

    <section id="contact-us">
      <h2>Send a Message</h2>
      <p>
        Do you have a question, a secret to share, or an eerie suggestion? Send
        us a raven message!
      </p>
      <form id="contact-form">
        <label for="contact-name">Your Name</label>
        <input
          type="text"
          id="contact-name"
          placeholder="Enter your name..."
          required
        />

        <label for="contact-email">Your Email</label>
        <input
          type="email"
          id="contact-email"
          placeholder="Enter your email..."
          required
        />

        <label for="contact-message">Your Message</label>
        <textarea
          id="contact-message"
          placeholder="Type your message here..."
          required
        ></textarea>

        <button type="submit">Send Message</button>
        <div id="contact-success-message" class="success-message"></div>
      </form>
    </section>

    <section id="about">
      <h2>About</h2>
      <p>
        This web app was created in a 48h hackathon by a team of beginner
        developers from Romania. Inspired by our culture and humanity, we
        believe every drop tells a story. And perhaps, awakens something more
        primal within us all.
      </p>
    </section>

    <button id="sound-toggle-button" aria-label="Toggle Sound">
      <img
        id="sound-off-icon"
        src="haut-parleur-rouge-et-icone-sonore.png"
        alt="Sound Off"
      />
      <img
        id="sound-on-icon"
        src="icone-du-son-et-du-haut-parleur-rouge.png"
        alt="Sound On"
      />
    </button>

    <div id="donation-confirmation-box">
      <img
        src="vampire-lips-sticker-u56fd-x450.png"
        alt="Vampire Lips Sticker"
      />
      <p>YOU ARE VERY BLOODYLICIOUS</p>
    </div>

    <!-- Container pentru jocul 3D -->
    <div id="lab-container" class="lab-container">
      <button class="close-lab" id="close-lab">×</button>
      <div class="lab-header">
        <h1>3D Transfusion Lab</h1>
        <p id="instructions">
          Drag the syringe to the patient's arm to collect blood.
        </p>

        <div id="confirmation-wrapper" class="hidden">
          <select id="blood-type-select"></select>
          <button id="confirm-type-button">Confirm Blood Type</button>
        </div>

        <div id="final-feedback-overlay" class="hidden">
          <div id="final-feedback-text"></div>
          <button id="next-patient-button">Next Patient</button>
        </div>
      </div>

      <div id="lab-canvas-container" class="lab-canvas-container"></div>
    </div>

    <!-- Scripturi -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/three@0.166.1/build/three.min.js"></script>
    <script>
      // Initial Welcome Overlay
      document.addEventListener("DOMContentLoaded", () => {
        const initialWelcomeOverlay = document.getElementById(
          "initial-welcome-overlay"
        );
        const enterSiteButton = document.getElementById("enter-site-button");
        const batSound = document.getElementById("bat-sound");

        enterSiteButton.addEventListener("click", () => {
          initialWelcomeOverlay.classList.add("hidden");
          if (batSound) {
            batSound
              .play()
              .catch((e) => console.error("Audio play failed:", e));
            batSound.volume = 0.3;
          }
        });
      });

      // Sound Toggle Button
      const soundToggleButton = document.getElementById("sound-toggle-button");
      const soundOnIcon = document.getElementById("sound-on-icon");
      const soundOffIcon = document.getElementById("sound-off-icon");
      const batSound = document.getElementById("bat-sound");
      const chimeSound = document.getElementById("chime-sound");
      const typingSound = document.getElementById("typing-sound");
      const evilLaughSound = document.getElementById("evil-laugh-sound");
      const wolfHowlSound = document.getElementById("wolf-howl-sound");

      let isSoundOn = false;

      soundToggleButton.addEventListener("click", () => {
        if (isSoundOn) {
          if (batSound) batSound.pause();
          if (chimeSound) chimeSound.pause();
          if (typingSound) typingSound.pause();
          if (evilLaughSound) evilLaughSound.pause();
          if (wolfHowlSound) wolfHowlSound.pause();

          soundOnIcon.style.display = "none";
          soundOffIcon.style.display = "block";
        } else {
          if (batSound)
            batSound
              .play()
              .catch((e) => console.error("Audio play failed:", e));
          soundOnIcon.style.display = "block";
          soundOffIcon.style.display = "none";
        }
        isSoundOn = !isSoundOn;
      });

      // Bat animation
      const batContainer = document.getElementById("bat-container");

      const createBat = () => {
        const bat = document.createElement("img");
        bat.src = "halloween-flying-bat-sticker-u889c-x450.png";
        bat.alt = "bat";
        bat.classList.add("bat");
        batContainer.appendChild(bat);

        const startY = Math.random() * (window.innerHeight * 0.8);
        const midY = Math.random() * (window.innerHeight * 0.8);
        const endY = Math.random() * (window.innerHeight * 0.8);
        const duration = Math.random() * 10 + 5;
        const direction = Math.random() > 0.5 ? "right" : "left";

        bat.style.setProperty("--startY", `${startY}px`);
        bat.style.setProperty("--midY", `${midY}px`);
        bat.style.setProperty("--endY", `${endY}px`);
        bat.style.animation = `${
          direction === "right" ? "flyToRight" : "flyToLeft"
        } ${duration}s linear forwards`;

        bat.addEventListener("animationend", () => {
          bat.remove();
          createBat();
        });
      };

      for (let i = 0; i < 5; i++) {
        createBat();
      }

      // Mouse Glow Effect
      const mouseGlow = document.getElementById("mouse-glow");
      document.addEventListener("mousemove", (e) => {
        mouseGlow.style.left = `${e.clientX}px`;
        mouseGlow.style.top = `${e.clientY}px`;
        mouseGlow.style.opacity = 1;
      });

      document.addEventListener("mouseleave", () => {
        mouseGlow.style.opacity = 0;
      });

      // Blood Drip on click
      document.addEventListener("click", (e) => {
        const dripSound = document.getElementById("drip-sound");
        if (dripSound && isSoundOn) {
          dripSound.currentTime = 0;
          dripSound
            .play()
            .catch((e) => console.error("Drip sound play failed:", e));
        }

        const drop = document.createElement("div");
        drop.classList.add("blood-drop");
        drop.style.left = `${e.clientX}px`;
        drop.style.top = `${e.clientY}px`;
        document.body.appendChild(drop);

        drop.addEventListener("animationend", () => {
          drop.remove();
        });
      });

      // Mist Effect on Scroll
      document.addEventListener("scroll", () => {
        const mistOverlay = document.getElementById("mist-overlay");
        const scrollPercentage = Math.min(
          1,
          window.scrollY / (document.body.scrollHeight - window.innerHeight)
        );
        mistOverlay.style.height = `${scrollPercentage * 100}%`;
      });

      // Local Storage for Donors
      let registeredDonors = JSON.parse(localStorage.getItem("donors")) || [];
      let bloodInventory =
        JSON.parse(localStorage.getItem("bloodInventory")) || {};

      const saveDonors = () => {
        localStorage.setItem("donors", JSON.stringify(registeredDonors));
      };

      const saveBloodInventory = () => {
        localStorage.setItem("bloodInventory", JSON.stringify(bloodInventory));
      };

      const updateDonorList = () => {
        const donorList = document.getElementById("donor-list");
        const noDonorsMessage = document.getElementById("no-donors-message");
        donorList.innerHTML = "";

        if (registeredDonors.length === 0) {
          noDonorsMessage.style.display = "block";
        } else {
          noDonorsMessage.style.display = "none";
          registeredDonors.forEach((donor) => {
            const listItem = document.createElement("li");
            listItem.innerHTML = `<strong>${donor.name}</strong> (${donor.group})`;
            donorList.appendChild(listItem);
          });
        }
      };

      const updateBloodInventory = () => {
        const inventorySummary = document.getElementById("inventory-summary");
        let summaryText = "";
        let isEmpty = true;

        for (const group in bloodInventory) {
          if (bloodInventory[group] > 0) {
            summaryText += `${group}: ${bloodInventory[group]} units<br>`;
            isEmpty = false;
          }
        }

        if (isEmpty) {
          inventorySummary.innerHTML = "No blood data available.";
        } else {
          inventorySummary.innerHTML = summaryText;
        }
      };

      const clearAllDonors = () => {
        if (confirm("Are you sure you want to clear all donor data?")) {
          registeredDonors = [];
          bloodInventory = {};
          saveDonors();
          saveBloodInventory();
          updateDonorList();
          updateBloodInventory();
          alert("All local donor data has been cleared.");
        }
      };

      const submitDonor = () => {
        const nameInput = document.getElementById("name");
        const groupSelect = document.getElementById("group");
        const outputDiv = document.getElementById("output");
        const donationConfirmationBox = document.getElementById(
          "donation-confirmation-box"
        );
        const letterSection = document.getElementById("letter");

        const donorName = nameInput.value.trim();
        const bloodGroup = groupSelect.value;

        if (donorName) {
          const newDonor = { name: donorName, group: bloodGroup };
          registeredDonors.push(newDonor);
          saveDonors();
          updateDonorList();

          bloodInventory[bloodGroup] = (bloodInventory[bloodGroup] || 0) + 1;
          saveBloodInventory();
          updateBloodInventory();

          if (chimeSound && isSoundOn) {
            chimeSound.currentTime = 0;
            chimeSound
              .play()
              .catch((e) => console.error("Chime sound play failed:", e));
          }
          donationConfirmationBox.classList.add("show");
          setTimeout(() => {
            donationConfirmationBox.classList.remove("show");
          }, 4000);

          const letterContent = `Dear ${donorName},\n\nWe extend our deepest gratitude for your generous contribution to the Transylvania Blood Network. Your vital essence flows through our ancient veins, nourishing the very spirit of our land. Your courage is truly admirable, and your donation ensures the continuation of life, both seen and unseen.\n\nMay your nights be long and your dreams... eternal.\n\nWith profound appreciation,\nThe Transylvania Blood Network`;

          outputDiv.innerHTML = "";
          let i = 0;
          const typingInterval = 50;

          if (typingSound && isSoundOn) {
            typingSound.currentTime = 0;
            typingSound
              .play()
              .catch((e) => console.error("Typing sound play failed:", e));
          }

          const typeWriter = () => {
            if (i < letterContent.length) {
              outputDiv.innerHTML += letterContent.charAt(i);
              i++;
              setTimeout(typeWriter, typingInterval);
            } else {
              if (typingSound) typingSound.pause();
              outputDiv.classList.remove("typing-cursor");
            }
          };
          outputDiv.classList.add("typing-cursor");
          typeWriter();

          letterSection.scrollIntoView({ behavior: "smooth" });

          nameInput.value = "";
        } else {
          alert("Please enter your name to become a donor.");
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        updateDonorList();
        updateBloodInventory();
      });

      // Vampire Facts
      const vampireFacts = [
        "Vampires are mythical beings who subsist by feeding on the life essence (generally in the form of blood) of living creatures.",
        "The most famous vampire is Count Dracula from Bram Stoker's 1897 novel 'Dracula'.",
        "Vampires are often depicted as immortal, able to transform into bats or mist, and possessing superhuman strength.",
        "Garlic, holy water, sunlight, and a wooden stake through the heart are common weaknesses of vampires.",
        "The word 'vampire' entered the English language in 1734, after a wave of vampire hysteria in Eastern Europe.",
        "Some folklore suggests vampires cannot cross running water or enter a home without an invitation.",
        "The first recorded vampire stories date back to ancient Mesopotamian and Hebrew mythologies.",
        "In some cultures, a 'vampire' could be a revenant, a deceased person returning to harm the living.",
        "The pallid appearance of vampires in folklore might stem from observations of decaying corpses.",
      ];

      const displayRandomVampireFact = () => {
        const factOutput = document.getElementById("vampire-fact-output");
        const randomIndex = Math.floor(Math.random() * vampireFacts.length);
        factOutput.textContent = vampireFacts[randomIndex];
      };

      // Blood Craving Compatibility
      const bloodCravings = {
        "A+": "Craves clarity and intellectual stimulation.",
        "A-": "Desires solitude and deep contemplation.",
        "B+": "Longs for adventure and new experiences.",
        "B-": "Seeks independence and unconventional paths.",
        "AB+": "A balanced hunger for knowledge and connection.",
        "AB-": "A mysterious craving for the unknown and hidden truths.",
        "O+": "Yearns for strength and leadership.",
        "O-": "Pines for universal understanding and ancient power.",
      };

      const getBloodCraving = () => {
        const cravingGroup = document.getElementById("craving-group").value;
        const cravingOutput = document.getElementById("craving-output");
        cravingOutput.textContent = bloodCravings[cravingGroup];
      };

      // Catch Vlad Game
      const gameArea = document.getElementById("game-area");
      const scoreDisplay = document.getElementById("score-display");
      const timerDisplay = document.getElementById("timer-display");
      const gameStartButton = document.getElementById("game-start-button");

      let score = 0;
      let timeLeft = 30;
      let gameTimer;
      let vladInterval;
      let isGameRunning = false;

      const spawnVlad = () => {
        if (!isGameRunning) return;

        const vlad = document.createElement("img");
        vlad.src = "Vlad_Tepes_002.jpg";
        vlad.alt = "Vlad Tepes";
        vlad.classList.add("game-bat");
        gameArea.appendChild(vlad);

        const maxX = gameArea.clientWidth - vlad.offsetWidth;
        const maxY = gameArea.clientHeight - vlad.offsetHeight;

        let randomX = Math.random() * maxX;
        let randomY = Math.random() * maxY;

        randomX = Math.max(0, Math.min(randomX, maxX));
        randomY = Math.max(0, Math.min(randomY, maxY));

        vlad.style.left = `${randomX}px`;
        vlad.style.top = `${randomY}px`;

        vlad.onclick = () => {
          score++;
          scoreDisplay.textContent = `Score: ${score}`;
          vlad.remove();
          if (isSoundOn && wolfHowlSound) {
            wolfHowlSound.currentTime = 0;
            wolfHowlSound
              .play()
              .catch((e) => console.error("Wolf howl sound play failed:", e));
          }
        };

        setTimeout(() => {
          if (vlad.parentNode === gameArea) {
            vlad.remove();
          }
        }, 1500);
      };

      const startGame = () => {
        score = 0;
        timeLeft = 30;
        isGameRunning = true;
        scoreDisplay.textContent = "Score: 0";
        timerDisplay.textContent = "Time: 30s";
        gameArea.innerHTML = "";
        gameStartButton.disabled = true;
        gameStartButton.classList.add("disabled");
        if (isSoundOn && evilLaughSound) {
          evilLaughSound.currentTime = 0;
          evilLaughSound
            .play()
            .catch((e) => console.error("Evil laugh sound play failed:", e));
        }

        gameTimer = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `Time: ${timeLeft}s`;
          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);

        vladInterval = setInterval(spawnVlad, 800);
      };

      const endGame = () => {
        clearInterval(gameTimer);
        clearInterval(vladInterval);
        isGameRunning = false;
        gameStartButton.disabled = false;
        gameStartButton.classList.remove("disabled");
        timerDisplay.textContent = `Time: 0s - Game Over!`;
        alert(`Game Over! Your final score is: ${score}`);
      };

      gameStartButton.addEventListener("click", startGame);

      // Vampire Quiz
      const quizQuestions = [
        {
          question: "What is a traditional weakness of vampires?",
          options: ["Sunlight", "Chocolate", "Loud noises", "Warm blankets"],
          answer: "Sunlight",
        },
        {
          question:
            "Which country is most commonly associated with vampire folklore?",
          options: ["France", "Romania", "Egypt", "Brazil"],
          answer: "Romania",
        },
        {
          question:
            "What animal is a vampire often depicted transforming into?",
          options: ["Wolf", "Owl", "Bat", "Cat"],
          answer: "Bat",
        },
        {
          question: "What is the name of the famous vampire hunter?",
          options: [
            "Van Helsing",
            "Sherlock Holmes",
            "James Bond",
            "Indiana Jones",
          ],
          answer: "Van Helsing",
        },
        {
          question: "What does a vampire typically drink?",
          options: ["Water", "Coffee", "Blood", "Milk"],
          answer: "Blood",
        },
        {
          question:
            "Which of these is NOT a common way to kill a vampire in folklore?",
          options: [
            "Wooden stake through the heart",
            "Decapitation",
            "Silver bullet",
            "Holy water",
          ],
          answer: "Silver bullet",
        },
        {
          question: "What time of day are vampires typically most powerful?",
          options: ["Morning", "Noon", "Dusk", "Night"],
          answer: "Night",
        },
        {
          question: "What food is said to repel vampires?",
          options: ["Garlic", "Onions", "Potatoes", "Apples"],
          answer: "Garlic",
        },
        {
          question:
            "In some legends, what must a vampire be invited to do to enter a home?",
          options: [
            "Sing a song",
            "Knock three times",
            "Be invited",
            "Bring a gift",
          ],
          answer: "Be invited",
        },
        {
          question:
            "What famous historical figure is often linked to the Dracula legend?",
          options: [
            "Vlad the Impaler",
            "Genghis Khan",
            "Julius Caesar",
            "Cleopatra",
          ],
          answer: "Vlad the Impaler",
        },
      ];

      let currentQuestionIndex = 0;
      let userAnswers = Array(quizQuestions.length).fill(null);

      const quizContainer = document.getElementById("quiz-container");
      const quizProgress = document.getElementById("quiz-progress");
      const prevQuestionBtn = document.getElementById("prev-question");
      const nextQuestionBtn = document.getElementById("next-question");
      const submitQuizBtn = document.getElementById("submit-quiz");
      const quizResultDiv = document.getElementById("quiz-result");
      const resultDescriptionDiv =
        document.getElementById("result-description");

      const loadQuestion = () => {
        const q = quizQuestions[currentQuestionIndex];
        quizContainer.innerHTML = `
                <div class="quiz-question">
                    <p>${q.question}</p>
                    <div class="quiz-options">
                        ${q.options
                          .map(
                            (option) => `
                                <label>
                                    <input type="radio" name="question${currentQuestionIndex}" value="${option}"
                                        ${
                                          userAnswers[currentQuestionIndex] ===
                                          option
                                            ? "checked"
                                            : ""
                                        }>
                                    ${option}
                                </label>
                            `
                          )
                          .join("")}
                    </div>
                </div>
            `;

        quizProgress.textContent = `Question ${currentQuestionIndex + 1} of ${
          quizQuestions.length
        }`;

        prevQuestionBtn.style.display =
          currentQuestionIndex === 0 ? "none" : "block";
        nextQuestionBtn.style.display =
          currentQuestionIndex === quizQuestions.length - 1 ? "none" : "block";
        submitQuizBtn.style.display =
          currentQuestionIndex === quizQuestions.length - 1 ? "block" : "none";

        quizContainer
          .querySelectorAll(`input[name="question${currentQuestionIndex}"]`)
          .forEach((radio) => {
            radio.addEventListener("change", (e) => {
              userAnswers[currentQuestionIndex] = e.target.value;
            });
          });
      };

      const nextQuestion = () => {
        const selectedOption = document.querySelector(
          `input[name="question${currentQuestionIndex}"]:checked`
        );
        if (selectedOption) {
          userAnswers[currentQuestionIndex] = selectedOption.value;
        }

        if (currentQuestionIndex < quizQuestions.length - 1) {
          currentQuestionIndex++;
          loadQuestion();
        }
      };

      const prevQuestion = () => {
        const selectedOption = document.querySelector(
          `input[name="question${currentQuestionIndex}"]:checked`
        );
        if (selectedOption) {
          userAnswers[currentQuestionIndex] = selectedOption.value;
        }

        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          loadQuestion();
        }
      };

      const submitQuiz = () => {
        const selectedOption = document.querySelector(
          `input[name="question${currentQuestionIndex}"]:checked`
        );
        if (selectedOption) {
          userAnswers[currentQuestionIndex] = selectedOption.value;
        }

        let correctAnswers = 0;
        for (let i = 0; i < quizQuestions.length; i++) {
          if (userAnswers[i] === quizQuestions[i].answer) {
            correctAnswers++;
          }
        }

        const scorePercentage = (correctAnswers / quizQuestions.length) * 100;
        let resultText = `You answered ${correctAnswers} out of ${quizQuestions.length} questions correctly.`;
        let descriptionText = "";

        if (scorePercentage >= 90) {
          descriptionText =
            "You are a true creature of the night! A master vampire!";
        } else if (scorePercentage >= 70) {
          descriptionText =
            "You have strong vampire tendencies. Beware the sun!";
        } else if (scorePercentage >= 40) {
          descriptionText =
            "You're a human with a peculiar interest in the occult. Keep learning!";
        } else {
          descriptionText =
            "You're definitely human. Perhaps too much sunlight?";
        }

        quizResultDiv.textContent = resultText;
        resultDescriptionDiv.textContent = descriptionText;
      };

      prevQuestionBtn.addEventListener("click", prevQuestion);
      nextQuestionBtn.addEventListener("click", nextQuestion);
      submitQuizBtn.addEventListener("click", submitQuiz);

      document.addEventListener("DOMContentLoaded", loadQuestion);

      // Countdown Timer
      const daysSpan = document.getElementById("days");
      const hoursSpan = document.getElementById("hours");
      const minutesSpan = document.getElementById("minutes");
      const secondsSpan = document.getElementById("seconds");
      const countdownMessage = document.getElementById("countdown-message");

      let countdownInterval;
      let targetDate;

      const startDemoCountdown = () => {
        targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + 3);
        targetDate.setHours(targetDate.getHours() + 5);
        targetDate.setMinutes(targetDate.getMinutes() + 10);
        targetDate.setSeconds(targetDate.getSeconds() + 30);

        countdownMessage.textContent =
          "Your transformation countdown has begun...";
        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(updateCountdown, 1000);
      };

      const updateCountdown = () => {
        const now = new Date().getTime();
        const distance = targetDate - now;

        if (distance < 0) {
          clearInterval(countdownInterval);
          countdownMessage.textContent =
            "The blood moon rises! Transformation complete!";
          countdownMessage.classList.add("countdown-finished");
          daysSpan.textContent = "00";
          hoursSpan.textContent = "00";
          minutesSpan.textContent = "00";
          secondsSpan.textContent = "00";
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        daysSpan.textContent = String(days).padStart(2, "0");
        hoursSpan.textContent = String(hours).padStart(2, "0");
        minutesSpan.textContent = String(minutes).padStart(2, "0");
        secondsSpan.textContent = String(seconds).padStart(2, "0");
      };

      // Contact Form
      const contactForm = document.getElementById("contact-form");
      const contactSuccessMessage = document.getElementById(
        "contact-success-message"
      );

      contactForm.addEventListener("submit", (e) => {
        e.preventDefault();
        contactSuccessMessage.textContent = "Your raven message has been sent!";
        contactSuccessMessage.style.display = "block";
        contactForm.reset();
        setTimeout(() => {
          contactSuccessMessage.style.display = "none";
        }, 5000);
      });

      // Funcționalitatea pentru jocul 3D
      document
        .getElementById("open-lab")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("lab-container").style.display = "block";
          init3DLab();
        });

      document
        .getElementById("close-lab")
        .addEventListener("click", function () {
          document.getElementById("lab-container").style.display = "none";
        });

      function init3DLab() {
        // --- CONSTANTS AND GAME DATA ---
        const ALL_BLOOD_TYPES = [
          "A+",
          "A-",
          "B+",
          "B-",
          "AB+",
          "AB-",
          "O+",
          "O-",
        ];
        const COMPATIBILITY_MAP = {
          "A+": ["A+", "A-", "O+", "O-"],
          "A-": ["A-", "O-"],
          "B+": ["B+", "B-", "O+", "O-"],
          "B-": ["B-", "O-"],
          "AB+": ALL_BLOOD_TYPES,
          "AB-": ["A-", "B-", "AB-", "O-"],
          "O+": ["O+", "O-"],
          "O-": ["O-"],
        };
        const AGGLUTINATION_RULES = {
          "A+": { A: true, B: false, Rh: true },
          "A-": { A: true, B: false, Rh: false },
          "B+": { A: false, B: true, Rh: true },
          "B-": { A: false, B: true, Rh: false },
          "AB+": { A: true, B: true, Rh: true },
          "AB-": { A: true, B: true, Rh: false },
          "O+": { A: false, B: false, Rh: true },
          "O-": { A: false, B: false, Rh: false },
        };
        const HIGHLIGHT_COLOR = 0x00ff00;

        // --- GLOBAL THREE.JS & GAME VARIABLES ---
        let scene, camera, renderer, raycaster, pointer;
        let table,
          patientArmGroup,
          syringe,
          bloodVial,
          testSlides = [],
          bloodDrops = [],
          bloodBags = [];
        let draggingObject = null,
          intersectionPlane;
        let hoveredTarget = { object: null, originalMaterial: null };
        let dragOffset = new THREE.Vector3();

        // --- GAME STATE ---
        let gameState = {
          patientBloodType: "",
          phase: "collect_blood",
          testsDone: { A: false, B: false, Rh: false },
        };

        // --- UI ELEMENTS ---
        const instructions = document.getElementById("instructions");
        const confirmationWrapper = document.getElementById(
          "confirmation-wrapper"
        );
        const bloodTypeSelect = document.getElementById("blood-type-select");
        const confirmTypeButton = document.getElementById(
          "confirm-type-button"
        );
        const finalFeedbackOverlay = document.getElementById(
          "final-feedback-overlay"
        );
        const finalFeedbackText = document.getElementById(
          "final-feedback-text"
        );
        const nextPatientButton = document.getElementById(
          "next-patient-button"
        );
        const canvasContainer = document.getElementById("lab-canvas-container");

        // --- INITIALIZATION ---
        function init() {
          scene = new THREE.Scene();
          scene.background = new THREE.Color(0x1a1a1a);
          camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
          );
          camera.position.set(0, 45, 40);
          camera.lookAt(0, 0, 0);
          renderer = new THREE.WebGLRenderer({ antialias: true });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.shadowMap.enabled = true;
          canvasContainer.appendChild(renderer.domElement);

          const ambientLight = new THREE.AmbientLight(0x404040, 1);
          scene.add(ambientLight);
          const pointLight = new THREE.PointLight(0xffffff, 3.5, 200);
          pointLight.position.set(0, 50, 20);
          pointLight.castShadow = true;
          scene.add(pointLight);
          const hemiLight = new THREE.HemisphereLight(0xffffbb, 0x080820, 1.5);
          scene.add(hemiLight);

          raycaster = new THREE.Raycaster();
          pointer = new THREE.Vector2();
          intersectionPlane = new THREE.Mesh(
            new THREE.PlaneGeometry(200, 200),
            new THREE.MeshBasicMaterial({
              visible: false,
              side: THREE.DoubleSide,
            })
          );
          intersectionPlane.rotation.x = -Math.PI / 2;
          intersectionPlane.position.y = 10;
          scene.add(intersectionPlane);

          createEnvironment();
          createInteractiveObjects();
          startNewPatient();

          window.addEventListener("resize", onWindowResize);
          canvasContainer.addEventListener("pointerdown", onPointerDown);
          canvasContainer.addEventListener("pointermove", onPointerMove);
          canvasContainer.addEventListener("pointerup", onPointerUp);
          confirmTypeButton.addEventListener("click", checkGuessedType);
          nextPatientButton.addEventListener("click", startNewPatient);

          animate();
        }

        // --- SCENE OBJECT CREATION ---
        function createEnvironment() {
          const tableGeometry = new THREE.BoxGeometry(100, 2, 50);
          const tableMaterial = new THREE.MeshStandardMaterial({
            color: 0x3a1a1a,
            roughness: 0.8,
          });
          table = new THREE.Mesh(tableGeometry, tableMaterial);
          table.receiveShadow = true;
          table.position.y = -1;
          scene.add(table);
          testSlides.push(createSlide("Anti-A", -25, "A"));
          testSlides.push(createSlide("Anti-B", 0, "B"));
          testSlides.push(createSlide("Anti-Rh", 25, "Rh"));
          testSlides.forEach((slide) => scene.add(slide));
        }
        function createSlide(text, xPos, type) {
          const slideGroup = new THREE.Group();
          slideGroup.position.set(xPos, 0.1, 0);
          const slideGeometry = new THREE.BoxGeometry(15, 0.2, 15);
          const slideMaterial = new THREE.MeshStandardMaterial({
            color: 0xf5f5dc,
            roughness: 0.2,
            transparent: true,
            opacity: 0.8,
          });
          const slideMesh = new THREE.Mesh(slideGeometry, slideMaterial);
          slideMesh.receiveShadow = true;
          slideMesh.userData.originalMaterial = slideMaterial;
          slideGroup.add(slideMesh);
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = 256;
          canvas.height = 128;
          context.font = "bold 40px 'MedievalSharp'";
          context.fillStyle = "#2b0000";
          context.textAlign = "center";
          context.fillText(text, 128, 64);
          const texture = new THREE.CanvasTexture(canvas);
          const label = new THREE.Mesh(
            new THREE.PlaneGeometry(12, 6),
            new THREE.MeshBasicMaterial({ map: texture, transparent: true })
          );
          label.rotation.x = -Math.PI / 2;
          label.position.y = 0.11;
          slideGroup.add(label);
          slideGroup.userData = {
            isSlide: true,
            type: type,
            visualMesh: slideMesh,
          };
          return slideGroup;
        }
        function createInteractiveObjects() {
          patientArmGroup = new THREE.Group();
          patientArmGroup.position.set(-35, 5, 10);
          scene.add(patientArmGroup);
          const armGeometry = new THREE.CylinderGeometry(4, 4, 20, 32);
          const armMaterial = new THREE.MeshStandardMaterial({
            color: 0xbe9b85,
          });
          const patientArmMesh = new THREE.Mesh(armGeometry, armMaterial);
          patientArmMesh.castShadow = true;
          patientArmMesh.rotation.z = Math.PI / 4;
          patientArmMesh.userData.originalMaterial = armMaterial;
          patientArmGroup.add(patientArmMesh);
          const hitboxGeometry = new THREE.CylinderGeometry(8, 8, 25, 8);
          const hitboxMaterial = new THREE.MeshBasicMaterial({
            visible: false,
          });
          const patientArmHitbox = new THREE.Mesh(
            hitboxGeometry,
            hitboxMaterial
          );
          patientArmHitbox.rotation.z = Math.PI / 4;
          patientArmHitbox.userData = {
            isPatientArm: true,
            visualMesh: patientArmMesh,
          };
          patientArmGroup.add(patientArmHitbox);
          syringe = new THREE.Group();
          const barrel = new THREE.Mesh(
            new THREE.CylinderGeometry(1, 1, 10, 16),
            new THREE.MeshStandardMaterial({
              color: 0xcccccc,
              transparent: true,
              opacity: 0.9,
            })
          );
          const plunger = new THREE.Mesh(
            new THREE.CylinderGeometry(0.8, 0.8, 12, 16),
            new THREE.MeshStandardMaterial({
              color: 0x555555,
              transparent: true,
              opacity: 0.9,
            })
          );
          plunger.position.y = 3;
          syringe.add(barrel, plunger);
          syringe.castShadow = true;
          syringe.userData = { isSyringe: true, parts: [barrel, plunger] };
          scene.add(syringe);
          bloodVial = new THREE.Mesh(
            new THREE.CylinderGeometry(1.5, 1.5, 8, 32),
            new THREE.MeshStandardMaterial({
              color: 0x8b0000,
              roughness: 0.1,
              metalness: 0.2,
              transparent: true,
              opacity: 0.9,
            })
          );
          bloodVial.castShadow = true;
          bloodVial.userData = { isVial: true };
          scene.add(bloodVial);
        }
        function createBloodBag(type, position) {
          const bagGroup = new THREE.Group();
          const bagGeom = new THREE.BoxGeometry(6, 9, 2);
          const bagMat = new THREE.MeshStandardMaterial({ color: 0xd9534f });
          const bagMesh = new THREE.Mesh(bagGeom, bagMat);
          bagMesh.castShadow = true;
          bagGroup.add(bagMesh);
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = 128;
          canvas.height = 128;
          ctx.font = "bold 60px 'MedievalSharp'";
          ctx.fillStyle = "white";
          ctx.textAlign = "center";
          ctx.fillText(type, 64, 80);
          const texture = new THREE.CanvasTexture(canvas);
          const label = new THREE.Mesh(
            new THREE.PlaneGeometry(6, 6),
            new THREE.MeshBasicMaterial({ map: texture, transparent: true })
          );
          label.position.z = 1.01;
          bagGroup.add(label);
          bagGroup.position.copy(position);
          bagGroup.userData = {
            isBloodBag: true,
            type: type,
            parts: [bagMesh],
          };
          scene.add(bagGroup);
          return bagGroup;
        }

        // --- Game Logic ---
        function startNewPatient() {
          gameState.patientBloodType =
            ALL_BLOOD_TYPES[Math.floor(Math.random() * ALL_BLOOD_TYPES.length)];
          console.log(
            "New Patient. Blood Type (secret):",
            gameState.patientBloodType
          );
          gameState.phase = "collect_blood";
          gameState.testsDone = { A: false, B: false, Rh: false };
          draggingObject = null;
          bloodDrops.forEach((drop) => scene.remove(drop));
          bloodDrops = [];
          bloodBags.forEach((bag) => scene.remove(bag));
          bloodBags = [];
          syringe.position.set(-15, 10, 15);
          syringe.visible = true;
          syringe.userData.parts.forEach((p) => {
            p.material.opacity = 0.9;
            p.material.transparent = true;
          });
          bloodVial.visible = false;
          finalFeedbackOverlay.classList.add("hidden");
          confirmationWrapper.classList.add("hidden");
          updateInstructions(
            "1. Drag the syringe to the patient's arm to collect blood."
          );
          bloodTypeSelect.innerHTML = "";
          ALL_BLOOD_TYPES.forEach((type) => {
            const option = document.createElement("option");
            option.value = type;
            option.textContent = type;
            bloodTypeSelect.appendChild(option);
          });
        }
        function updateInstructions(text) {
          instructions.textContent = text;
        }
        function advancePhase(newPhase) {
          gameState.phase = newPhase;
          console.log("New phase:", newPhase);
          switch (newPhase) {
            case "test_blood":
              syringe.visible = false;
              bloodVial.position.set(-15, 6, 15);
              bloodVial.visible = true;
              bloodVial.material.opacity = 0.9;
              updateInstructions(
                "2. Drag the vial onto each slide to add blood."
              );
              break;
            case "determine_type":
              bloodVial.visible = false;
              updateInstructions(
                "3. Analyze the results and select the blood type."
              );
              confirmationWrapper.classList.remove("hidden");
              break;
            case "transfuse":
              updateInstructions(
                "4. Correct! Now choose a compatible blood bag and drag it to the patient."
              );
              confirmationWrapper.classList.add("hidden");
              populateBloodBank();
              break;
          }
        }

        function placeBloodDrop(targetSlide) {
          const slideType = targetSlide.userData.type;
          if (gameState.testsDone[slideType]) return;
          gameState.testsDone[slideType] = true;

          const dropGeometry = new THREE.SphereGeometry(3, 32, 16);
          const normalMaterial = new THREE.MeshStandardMaterial({
            color: 0x8b0000,
            roughness: 0.3,
          });
          const agglutinatedMaterial = new THREE.MeshPhysicalMaterial({
            color: 0x6a0000,
            roughness: 0.9,
            transmission: 0.4,
            thickness: 1.5,
          });
          const drop = new THREE.Mesh(dropGeometry, normalMaterial);
          drop.position.set(targetSlide.position.x, 1, targetSlide.position.z);
          drop.castShadow = true;
          scene.add(drop);
          bloodDrops.push(drop);

          const rule = AGGLUTINATION_RULES[gameState.patientBloodType];
          if (rule[slideType]) {
            setTimeout(() => {
              drop.material = agglutinatedMaterial;
              const clumpMaterial = new THREE.MeshBasicMaterial({
                color: 0x4a0000,
              });
              const mainDropRadius = 2.8; // Slightly less than the drop radius (3) to be on the surface

              // Add many more clumps for a visible effect
              for (let i = 0; i < 25; i++) {
                const clumpGeometry = new THREE.SphereGeometry(
                  0.3 + Math.random() * 0.5,
                  8,
                  8
                );
                const clump = new THREE.Mesh(clumpGeometry, clumpMaterial);

                // Position the clumps ON THE SURFACE of the large drop
                const phi = Math.random() * 2 * Math.PI;
                const theta = Math.acos(Math.random() * 2 - 1);
                clump.position.setFromSphericalCoords(
                  mainDropRadius,
                  phi,
                  theta
                );

                drop.add(clump);
              }
            }, 500);
          }

          if (Object.values(gameState.testsDone).every((v) => v === true)) {
            advancePhase("determine_type");
          }
        }

        function checkGuessedType() {
          const userChoice = bloodTypeSelect.value;
          if (userChoice === gameState.patientBloodType) {
            advancePhase("transfuse");
          } else {
            alert("Incorrect blood type! Analyze the slides again.");
          }
        }
        function populateBloodBank() {
          const shuffledTypes = [...ALL_BLOOD_TYPES].sort(
            () => Math.random() - 0.5
          );
          shuffledTypes.forEach((type, index) => {
            const x = -30 + (index % 4) * 20;
            const z = index < 4 ? -15 : -30;
            const pos = new THREE.Vector3(x, 10, z);
            bloodBags.push(createBloodBag(type, pos));
          });
        }

        function checkTransfusion(donorType) {
          const isCompatible =
            COMPATIBILITY_MAP[gameState.patientBloodType].includes(donorType);
          finalFeedbackOverlay.classList.remove("hidden");
          if (isCompatible) {
            finalFeedbackOverlay.className = "success";
            finalFeedbackText.innerHTML = `Congratulations!<br>Transfusion with ${donorType} is compatible.<br>Patient saved!`;
          } else {
            finalFeedbackOverlay.className = "error";
            finalFeedbackText.innerHTML = `DANGER!<br>Transfusion with ${donorType} is incompatible!<br>Procedure failed.`;
          }
          // The following line was commented out to keep the bags visible:
          // bloodBags.forEach(bag => bag.visible = false);
        }

        // --- MOUSE EVENTS & RAYCASTING ---
        function updatePointer(event) {
          const rect = renderer.domElement.getBoundingClientRect();
          pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        }

        function onPointerDown(event) {
          updatePointer(event);
          raycaster.setFromCamera(pointer, camera);

          let objectsToIntersect = [];
          if (gameState.phase === "collect_blood")
            objectsToIntersect = [syringe];
          if (gameState.phase === "test_blood")
            objectsToIntersect = [bloodVial];
          if (gameState.phase === "transfuse") objectsToIntersect = bloodBags;

          const intersects = raycaster.intersectObjects(
            objectsToIntersect,
            true
          );

          if (intersects.length > 0) {
            let intersectedObject = intersects[0].object;
            while (
              intersectedObject.parent &&
              !objectsToIntersect.includes(intersectedObject)
            ) {
              intersectedObject = intersectedObject.parent;
            }
            draggingObject = intersectedObject;
            canvasContainer.style.cursor = "grabbing";

            const planeIntersects =
              raycaster.intersectObject(intersectionPlane);
            if (planeIntersects.length > 0) {
              dragOffset
                .copy(draggingObject.position)
                .sub(planeIntersects[0].point);
            }

            draggingObject.userData.originalMaterials = [];
            const parts = draggingObject.userData.parts || [draggingObject];
            parts.forEach((p) => {
              if (p.material) {
                draggingObject.userData.originalMaterials.push(p.material);
                p.material = p.material.clone();
                p.material.transparent = true;
                p.material.opacity = 0.6;
              }
            });
          }
        }

        function onPointerMove(event) {
          if (draggingObject) {
            updatePointer(event);
            raycaster.setFromCamera(pointer, camera);

            const planeIntersects =
              raycaster.intersectObject(intersectionPlane);
            if (planeIntersects.length > 0) {
              const point = planeIntersects[0].point;
              draggingObject.position.copy(point).add(dragOffset);
            }

            let dropTargets = [];
            if (
              gameState.phase === "collect_blood" ||
              gameState.phase === "transfuse"
            )
              dropTargets = [
                patientArmGroup.children.find((c) => c.userData.isPatientArm),
              ];
            if (gameState.phase === "test_blood") dropTargets = testSlides;
            const targetIntersects = raycaster.intersectObjects(
              dropTargets,
              true
            );

            if (targetIntersects.length > 0) {
              let hitObject = targetIntersects[0].object;
              let visualMesh =
                hitObject.userData.visualMesh ||
                (hitObject.parent.userData
                  ? hitObject.parent.userData.visualMesh
                  : null) ||
                hitObject;
              if (hoveredTarget.object !== visualMesh) {
                clearHover();
                hoveredTarget.object = visualMesh;
                hoveredTarget.originalMaterial =
                  visualMesh.userData.originalMaterial;
                visualMesh.material = new THREE.MeshStandardMaterial({
                  color: HIGHLIGHT_COLOR,
                  emissive: HIGHLIGHT_COLOR,
                  emissiveIntensity: 0.5,
                });
              }
            } else {
              clearHover();
            }
          }
        }

        function onPointerUp(event) {
          if (draggingObject) {
            // Restore original materials of the dragged object
            const parts = draggingObject.userData.parts || [draggingObject];
            if (draggingObject.userData.originalMaterials) {
              parts.forEach((p, index) => {
                if (p.material) {
                  p.material.dispose();
                  p.material = draggingObject.userData.originalMaterials[index];
                }
              });
              delete draggingObject.userData.originalMaterials;
            }

            const PROXIMITY_THRESHOLD_ARM = 20.0; // Max distance to consider a valid action on the arm

            // Phase 1: Collect blood (Syringe -> Arm)
            if (
              gameState.phase === "collect_blood" &&
              draggingObject.userData.isSyringe
            ) {
              const distance = draggingObject.position.distanceTo(
                patientArmGroup.position
              );
              if (distance < PROXIMITY_THRESHOLD_ARM) {
                advancePhase("test_blood");
              }
            }
            // Phase 2: Test blood (Vial -> Slides) - requires precision, use original hover
            else if (
              gameState.phase === "test_blood" &&
              hoveredTarget.object &&
              hoveredTarget.object.parent.userData.isSlide
            ) {
              placeBloodDrop(hoveredTarget.object.parent);
            }
            // Phase 4: Transfusion (Bag -> Arm)
            else if (
              gameState.phase === "transfuse" &&
              draggingObject.userData.isBloodBag
            ) {
              const distance = draggingObject.position.distanceTo(
                patientArmGroup.position
              );
              if (distance < PROXIMITY_THRESHOLD_ARM + 5) {
                // Slightly more tolerance for the bag
                checkTransfusion(draggingObject.userData.type);
                draggingObject.visible = false;
              }
            }

            // Clear hover and drag state
            clearHover();
            draggingObject = null;
            canvasContainer.style.cursor = "grab";
          }
        }

        function clearHover() {
          if (hoveredTarget.object) {
            hoveredTarget.object.material.dispose();
            hoveredTarget.object.material = hoveredTarget.originalMaterial;
            hoveredTarget.object = null;
            hoveredTarget.originalMaterial = null;
          }
        }

        function onWindowResize() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
        function animate() {
          requestAnimationFrame(animate);
          renderer.render(scene, camera);
        }

        init();
      }

      // Funcționalitatea pentru hartă
      const mapSection = document.createElement("section");
      mapSection.id = "transylvania-map";
      mapSection.innerHTML = `
            <h2>Blood Donation Centers in Transylvania</h2>
            <div id="map"></div>
        `;
      document.body.insertBefore(mapSection, document.querySelector("section"));

      document
        .querySelector('nav a[href="#transylvania-map"]')
        .addEventListener("click", function (e) {
          e.preventDefault();
          if (mapSection.style.display === "none") {
            mapSection.style.display = "block";
            initMap();
            mapSection.scrollIntoView({ behavior: "smooth" });
          } else {
            mapSection.style.display = "none";
          }
        });

      function initMap() {
        const map = L.map("map").setView([46.7712, 23.6236], 7);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        const centres = [
          {
            city: "Cluj-Napoca",
            coords: [46.7712, 23.6236],
            details: "Centrul Regional de Transfuzie Sanguină Cluj",
          },
          {
            city: "Târgu Mureș",
            coords: [46.5428, 24.5586],
            details: "Centrul de Transfuzie Mureș",
          },
          {
            city: "Sibiu",
            coords: [45.7928, 24.1521],
            details: "Centrul de Transfuzie Sanguină Sibiu",
          },
          {
            city: "Brașov",
            coords: [45.6579, 25.6012],
            details: "Centrul de Transfuzie Sanguină Brașov",
          },
          {
            city: "Oradea",
            coords: [47.0722, 21.9211],
            details: "Centrul de Transfuzie Sanguină Oradea",
          },
        ];

        centres.forEach((centre) => {
          L.marker(centre.coords)
            .addTo(map)
            .bindPopup(`<strong>${centre.city}</strong><br>${centre.details}`);
        });
      }
    </script>
  </body>
</html>
